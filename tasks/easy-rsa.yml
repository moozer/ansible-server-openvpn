# easy rsa certificate handling

- name: installing easy-rsa
  #become: yes
  apt: name={{ item }} state=present
  with_items: 
  - easy-rsa
  - openvpn
  
- name: check easy-rsa state
  stat: path={{ easy_rsa_dir }}
  register: easy_rsa_installed

- name: create CA
  shell: make-cadir "{{ easy_rsa_dir }}"
  when: not easy_rsa_installed.stat.exists
  
- name: create symlink
  file: src="openssl-1.0.0.cnf" dest="{{ easy_rsa_dir }}/openssl.cnf" state=link

- name: create vars file
  template: src=vars.j2 dest="{{ easy_rsa_dir }}/vars"

- name: create keys dir
  file: state=directory dest={{ easy_rsa_key_dir }} mode=0700

- name: create empty index file
  command: "touch {{ easy_rsa_key_dir }}/index.txt"
  args:
    creates: "{{ easy_rsa_key_dir }}/index.txt"

- name: create serial minimal serial
  shell: "cd {{ easy_rsa_key_dir }} && echo 01 >> serial"
  args:
    creates: "{{ easy_rsa_key_dir }}/serial"

- name: generate dh file
  shell: "cd {{ easy_rsa_dir }} && . ./vars && ./build-dh"
  args:
    creates: "{{ easy_rsa_dh_file }}"

- name: generate CA key + crt file
  shell: "cd {{ easy_rsa_dir }} && . ./vars && ./pkitool --initca"
  args:
    creates: "{{ easy_rsa_ca_crt_file }}"

- name: generate server key file
  shell: "cd {{ easy_rsa_dir }} && . ./vars && ./pkitool --server {{ openvpn_server_name }}"
  args:
    creates: "{{ easy_rsa_server_key_file }}"

- name: generate HMAC key file
  shell: /usr/sbin/openvpn --genkey --secret {{ easy_rsa_ta_crt_file }}
  args:
    creates: "{{ easy_rsa_ta_crt_file }}"

- name: copy client creation script
  template: src={{ easy_rsa_client_creation_filename }}
            dest={{ easy_rsa_client_creation_script }}
            mode=0755
